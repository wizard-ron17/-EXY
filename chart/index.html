<!DOCTYPE html>
<html lang="en">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>$EXY Chart</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/apexcharts/3.35.0/apexcharts.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/dayjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/plugin/relativeTime.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="./chart.css">
    <link rel="shortcut icon" type="image/x-icon" href="https://github.com/wizard-ron17/rondex/blob/main/400x400.png?raw=true">
    <link rel="apple-touch-icon" sizes="180x180" href="https://github.com/wizard-ron17/rondex/blob/main/400x400.png?raw=true">
    <script>
        dayjs.extend(window.dayjs_plugin_relativeTime);
    </script>
    <style>
        /* Trades styles */
        .trades-container {
            margin-top: 20px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            padding: 10px;
            background-color: #1a2332;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            overflow-x: auto;
            color: #fff;
            max-width: 90%;
            margin: 20px auto;
        }
        .volume-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
            background-color: #1b293f;
            padding: 15px;
            border-radius: 6px;
        }
        .volume-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .volume-label {
            font-size: 0.9rem;
            color: #888;
        }
        .volume-value {
            font-size: 1.1rem;
            font-weight: 500;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 0.9rem;
            color: #fff;
        }
        th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #333;
        }
        th {
            background-color: #1b293f;
            font-weight: 600;
            color: #fff;
        }
        tr:hover {
            background-color: #1b293f;
        }
        .buy {
            color: #00ff9f;
            font-weight: 500;
        }
        .sell {
            color: #ff8afb;
            font-weight: 500;
        }
        .trades-loading {
            text-align: center;
            padding: 20px;
            font-size: 18px;
            color: #888;
        }
        .error {
            color: #f44336;
            padding: 20px;
            text-align: center;
        }
        .trades-container a {
            color: #64b5f6;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .trades-container a:hover {
            color: #90caf9;
        }
        .time {
            white-space: nowrap;
        }
        .explorer-link {
            width: 24px;
            height: 24px;
        }
        
        /* Mobile optimizations */
        @media (max-width: 768px) {
            .trades-container {
                padding: 8px;
            }
            table {
                font-size: 0.75rem;
            }
            th, td {
                padding: 4px;
            }
            .time {
                min-width: 40px;
            }
            .number-col {
                min-width: 60px;
            }
            .volume-summary {
                grid-template-columns: 1fr;
                gap: 8px;
                padding: 10px;
            }
            .volume-label {
                font-size: 0.8rem;
            }
            .volume-value {
                font-size: 1rem;
            }
            .explorer-link {
                width: 20px;
                height: 20px;
            }
        }

        /* Extra small screens */
        @media (max-width: 375px) {
            table {
                font-size: 0.7rem;
            }
            th, td {
                padding: 3px;
            }
            .trades-container {
                padding: 5px;
            }
            .number-col {
                min-width: 50px;
            }
        }
    </style>
</head>
    
<body>
    <div class="chart-container">
        <div class="interval-toggle">
            <button class="interval-btn" data-interval="60">1H</button>
            <button class="interval-btn active" data-interval="240">4H</button>
            <button class="interval-btn" data-interval="720">12H</button>
            <button class="interval-btn" data-interval="1440">1D</button>
            <button class="interval-btn" data-interval="10080">1W</button>
        </div>
        <div id="loading" class="loading">Loading $EXY price data...</div>
        <div id="chart"></div>
    </div>

    <div class="trades-container">
        <h1>Swap History</h1>
        <div id="trades-content">
            <div class="trades-loading">Loading trades data...</div>
        </div>
    </div>
</body>

<script src="./chart.js"></script>
<script>
    // Trades functionality
    async function fetchTrades() {
        try {
            const response = await fetch('https://rons-server.netlify.app/.netlify/functions/server/api/historical-trades/exy');
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            const data = await response.json();
            return data.sort((a, b) => parseInt(b.trade_timestamp) - parseInt(a.trade_timestamp));
        } catch (error) {
            console.error('Error fetching trades:', error);
            throw error;
        }
    }

    function formatPrice(num) {
        return new Intl.NumberFormat('en-US', {
            minimumFractionDigits: 6,
            maximumFractionDigits: 6,
            notation: 'standard'
        }).format(num);
    }

    function formatAmount(num) {
        return new Intl.NumberFormat('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
            notation: 'compact',
            compactDisplay: 'short'
        }).format(num);
    }

    function formatRelativeTime(timestamp) {
        const now = dayjs();
        const time = dayjs(parseInt(timestamp));
        const diffMinutes = now.diff(time, 'minute');
        const diffHours = now.diff(time, 'hour');
        const diffDays = now.diff(time, 'day');

        if (diffMinutes < 60) {
            return `${diffMinutes}m`;
        } else if (diffHours < 24) {
            return `${diffHours}h`;
        } else {
            return `${diffDays}d`;
        }
    }

    function calculate24hVolume(trades) {
        const oneDayAgo = Date.now() - (24 * 60 * 60 * 1000);
        const recentTrades = trades.filter(trade => 
            parseInt(trade.trade_timestamp) > oneDayAgo
        );

        const buyVolume = recentTrades
            .filter(trade => trade.type === 'buy')
            .reduce((sum, trade) => sum + parseFloat(trade.target_volume), 0);

        const sellVolume = recentTrades
            .filter(trade => trade.type === 'sell')
            .reduce((sum, trade) => sum + parseFloat(trade.target_volume), 0);

        return {
            buyVolume,
            sellVolume,
            totalVolume: buyVolume + sellVolume
        };
    }

    function createVolumeSummary(volumes) {
        return `
            <div class="volume-summary">
                <div class="volume-item">
                    <span class="volume-label">24h Buy Volume</span>
                    <span class="volume-value buy">${formatAmount(volumes.buyVolume)} $EX</span>
                </div>
                <div class="volume-item">
                    <span class="volume-label">24h Sell Volume</span>
                    <span class="volume-value sell">${formatAmount(volumes.sellVolume)} $EX</span>
                </div>
                <div class="volume-item">
                    <span class="volume-label">24h Total Volume</span>
                    <span class="volume-value">${formatAmount(volumes.totalVolume)} $EX</span>
                </div>
            </div>
        `;
    }

    function updateRelativeTimes() {
        const timeElements = document.querySelectorAll('.time');
        timeElements.forEach(element => {
            const timestamp = element.getAttribute('data-timestamp');
            element.textContent = formatRelativeTime(timestamp);
        });
    }

    function createTable(trades) {
        // Limit to last 50 trades
        const recentTrades = trades.slice(0, 50);
        
        return `
            <table>
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Type</th>
                        <th class="number-col">Price</th>
                        <th class="number-col">$EXY</th>
                        <th class="number-col">$EX</th>
                        <th>TX</th>
                    </tr>
                </thead>
                <tbody>
                    ${recentTrades.map(trade => `
                        <tr>
                            <td>
                                <span class="time" data-timestamp="${trade.trade_timestamp}">
                                    ${formatRelativeTime(trade.trade_timestamp)}
                                </span>
                            </td>
                            <td class="${trade.type}">${trade.type.toUpperCase()}</td>
                            <td class="number-col">${formatPrice(trade.price)}</td>
                            <td class="number-col">${formatAmount(trade.base_volume)}</td>
                            <td class="number-col">${formatAmount(trade.target_volume)}</td>
                            <td>
                                <a href="https://explorer.alephium.org/transactions/${trade.tx_id}" 
                                   target="_blank" 
                                   class="explorer-link"
                                   title="View on Explorer">
                                    <i class="fas fa-external-link-alt"></i>
                                </a>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
    }

    async function initTrades() {
        const contentDiv = document.getElementById('trades-content');
        try {
            const trades = await fetchTrades();
            const volumes = calculate24hVolume(trades);
            
            contentDiv.innerHTML = createVolumeSummary(volumes) + createTable(trades);
            
            setInterval(updateRelativeTimes, 30000);
        } catch (error) {
            contentDiv.innerHTML = `<div class="error">Error loading trades data: ${error.message}</div>`;
        }
    }

    document.addEventListener('DOMContentLoaded', initTrades);
</script>
    
</html>
